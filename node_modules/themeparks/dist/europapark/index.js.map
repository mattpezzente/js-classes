{"version":3,"sources":["../../lib/europapark/index.js"],"names":["Park","require","Moment","crypto","s_apiBase","Symbol","s_apiVersion","s_parkSecretToken","EuropaPark","options","name","latitude","longitude","useragent","timezone","api_base","api_version","secret_token","currentParkDate","utc","format","Log","hmac","createHmac","update","code","digest","toUpperCase","Cache","Wrap","Promise","resolve","reject","HTTP","url","then","ride_data","rideNames","i","poi","nameEnglish","nameGerman","bind","FetchRideData","data","GenerateAccessToken","waitTimes","length","rideIdx","ride","Rides","WaitTime","ridetime","rideObject","GetRideObject","id","waittime","time","active","status","openingTimes","sched","Schedule","SetRange","startDate","tz","from","Timezone","endDate","until","openingTime","start","closingTime","end","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\n\n// include core Park class\nvar Park = require(\"../park\");\nvar Moment = require(\"moment-timezone\");\n\n// crypto library for generating access tokens\nvar crypto = require(\"crypto\");\n\nvar s_apiBase = Symbol();\nvar s_apiVersion = Symbol();\nvar s_parkSecretToken = Symbol();\n\n/**\n * Implements the Europa Park API framework.\n * @class\n * @extends Park\n */\nclass EuropaPark extends Park {\n    /**\n     * Create new EuropaPark Object.\n     * @param {Object} [options]\n     * @param {String} [options.api_base] Optional base URL for API requests \n     * @param {String} [options.api_version] API Version to make requests to (default: 'api-5.2') \n     * @param {String} [options.secret_token] Secret token to use to generate the wait times API access token\n     */\n    constructor(options = {}) {\n        options.name = options.name || \"Europa Park\";\n\n        // Europa-Park coordinates\n        options.latitude = options.latitude || 48.268931;\n        options.longitude = options.longitude || 7.721559;\n\n        // Use the Android app's user-agent\n        options.useragent = options.useragent || \"okhttp/2.7.0\";\n\n        // park's timezone\n        options.timezone = \"Europe/Berlin\";\n\n        // inherit from base class\n        super(options);\n\n        // accept overriding the API base URL\n        this[s_apiBase] = options.api_base || \"https://api.europapark.de/\";\n        // accept overriding API version\n        this[s_apiVersion] = options.api_version || \"api-5.4\";\n        // take secret token from options, or default to known token\n        this[s_parkSecretToken] = options.secret_token || \"ZhQCqoZp\";\n    }\n\n    /**\n     * Generate an access token for accessing wait times\n     * @returns {String} Current Access Token\n     */\n    GenerateAccessToken() {\n        // generate wait times access code\n\n        // start with current park date in UTC (YYYYMMDDHH format)\n        var currentParkDate = Moment.utc().format(\"YYYYMMDDHH\");\n        this.Log(\"Calculated token date as\", currentParkDate);\n\n        // sha256 hash using key\n        var hmac = crypto.createHmac(\"sha256\", this[s_parkSecretToken]);\n        hmac.update(currentParkDate);\n        var code = hmac.digest(\"hex\").toUpperCase();\n\n        this.Log(\"Generated Europa wait times code\", code);\n\n        return code;\n    }\n\n    /**\n     * Fetches fresh or cached ride data from the park API\n     * @returns {Promise<Object>} Object of Ride ID => Ride Name in English (or German if no English name is available)\n     */\n    FetchRideData() {\n        return this.Cache.Wrap(\"ridedata\", function() {\n            return new Promise(function(resolve, reject) {\n                // grab ride names from the API\n                this.HTTP({\n                    url: this[s_apiBase] + this[s_apiVersion] + \"/pointsofinterest\",\n                }).then(function(ride_data) {\n                    // extract names from returned data\n                    var rideNames = {};\n                    for (var i = 0, poi; poi = ride_data[i++];) {\n                        // types:\n                        //  1: ride\n                        //  2: food\n                        //  3: park entrance\n                        //  5: shop\n                        //  6: show\n\n                        // not all attractions have English names, so fallback to German if missing\n                        rideNames[poi.code] = poi.nameEnglish || poi.nameGerman;\n                    }\n\n                    resolve(rideNames);\n                }.bind(this), reject);\n            }.bind(this));\n        }.bind(this), 60 * 60 * 24);\n    }\n\n    /**\n     * Fetch Wait times\n     */\n    FetchWaitTimes() {\n        return new Promise(function(resolve, reject) {\n            // fetch ride names before getting wait times (usually this will come from the cache)\n            this.FetchRideData().then(function(rideNames) {\n                this.HTTP({\n                    url: `${this[s_apiBase]}${this[s_apiVersion]}/waitingtimes`,\n                    data: {\n                        \"mock\": false,\n                        \"token\": this.GenerateAccessToken()\n                    }\n                }).then(function(waitTimes) {\n                    // if empty, park is just totally closed (!)\n                    if (!waitTimes.length) {\n                        // mark each ride as inactive\n                        // loop through previously known-about rides\n                        for (var rideIdx, ride; ride = this.Rides[rideIdx++];) {\n                            // set ride time to -1 to mark as closed\n                            ride.WaitTime = -1;\n                        }\n\n                        // TODO - loop over a hard-coded list of known rides at the park\n\n                        // resolve early\n                        return resolve();\n                    }\n\n                    for (var i = 0, ridetime; ridetime = waitTimes[i++];) {\n                        // FYI, ridetime.type:\n                        //   1: rollercoaster\n                        //   2: water\n                        //   3: adventure\n\n                        // status meanings:\n                        //  0: Open!\n                        //  1: Wait time is over 90 minutes\n                        //  2: Closed\n                        //  3: Broken Down\n                        //  4: Bad weather\n                        //  5: VIP/Special Tour\n                        //  other: Probably just crazy long wait times\n\n                        // get this ride's' object\n                        var rideObject = this.GetRideObject({\n                            id: ridetime.code,\n                            name: rideNames[ridetime.code] || \"???\",\n                        });\n\n                        // lowest wait time is 1 minute (according to app)\n                        var waittime = ridetime.time > 0 ? ridetime.time : 0;\n                        var active = (ridetime.status === 0 || ridetime.status === 1);\n                        // copy how the app reacts to >90 minute waits\n                        if (ridetime.status === 1) waittime = 91;\n\n                        // set new wait time\n                        rideObject.WaitTime = active ? waittime : -1;\n                    }\n\n                    resolve();\n                }.bind(this), reject);\n            }.bind(this), reject);\n        }.bind(this));\n    }\n\n    /** \n     * Fetch Europa Park opening time data\n     * @returns {Promise}\n     */\n    FetchOpeningTimes() {\n        return new Promise(function(resolve, reject) {\n            this.HTTP({\n                url: `${this[s_apiBase]}${this[s_apiVersion]}/openingtimes`\n            }).then(function(openingTimes) {\n                for (var i = 0, sched; sched = openingTimes[i++];) {\n                    // EuropaPark returns opening hours in blocks of ranges\n                    //  set each range of dates in our schedule object \n                    this.Schedule.SetRange({\n                        startDate: Moment.tz(sched.from, \"YYYY-MM-DD\", this.Timezone),\n                        endDate: Moment.tz(sched.until, \"YYYY-MM-DD\", this.Timezone),\n                        openingTime: Moment(sched.start, \"HH:mm\"),\n                        closingTime: Moment(sched.end, \"HH:mm\")\n                    });\n                }\n\n                // TODO - the park is actually closed on various days and has announced varients to these times\n                //  find out how to get these properly!\n\n                resolve();\n            }.bind(this), reject);\n        }.bind(this));\n    }\n}\n\n// export the class\nmodule.exports = EuropaPark;"]}